<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIXIFY - Restablecer Contraseña</title>
    
    <!-- Control de cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        /* Estilos especificos para reset password */
        .reset-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .reset-card {
            background: var(--card-bg, #fff);
            border-radius: 24px;
            padding: 3rem;
            max-width: 460px;
            width: 100%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .reset-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary, #3b82f6), var(--accent-secondary, #8b5cf6));
        }
        
        .reset-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .reset-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        
        .reset-logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary, #3b82f6), var(--accent-secondary, #8b5cf6));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
        }
        
        .reset-logo-text {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary, #111827);
        }
        
        .reset-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary, #3b82f6) 0%, var(--accent-secondary, #8b5cf6) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
        }
        
        .reset-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary, #111827);
            margin-bottom: 0.5rem;
        }
        
        .reset-subtitle {
            color: var(--text-secondary, #6b7280);
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        .reset-form {
            margin-top: 1.5rem;
        }
        
        .reset-form-group {
            margin-bottom: 1.25rem;
        }
        
        .reset-form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary, #111827);
            margin-bottom: 0.5rem;
        }
        
        .reset-input-wrapper {
            position: relative;
        }
        
        .reset-input-wrapper .input-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary, #9ca3af);
            pointer-events: none;
        }
        
        .reset-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 2.75rem;
            border: 2px solid var(--border-color, #e5e7eb);
            border-radius: 12px;
            font-size: 1rem;
            color: var(--text-primary, #111827);
            background: var(--input-bg, #fff);
            transition: all 0.2s ease;
            outline: none;
        }
        
        .reset-input:focus {
            border-color: var(--accent-primary, #3b82f6);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
        
        .reset-input.error {
            border-color: #ef4444;
        }
        
        .reset-error {
            display: block;
            color: #ef4444;
            font-size: 0.8rem;
            margin-top: 0.5rem;
            min-height: 1.2em;
        }
        
        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-tertiary, #9ca3af);
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .password-toggle:hover {
            color: var(--text-secondary, #6b7280);
        }
        
        .password-toggle .eye-closed {
            display: none;
        }
        
        .password-toggle.active .eye-open {
            display: none;
        }
        
        .password-toggle.active .eye-closed {
            display: block;
        }
        
        .password-requirements {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary, #f3f4f6);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary, #6b7280);
        }
        
        .password-requirements ul {
            margin: 0.5rem 0 0;
            padding-left: 1.25rem;
        }
        
        .password-requirements li {
            margin-bottom: 0.25rem;
        }
        
        .password-requirements li.valid {
            color: #22c55e;
        }
        
        .reset-submit-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary, #3b82f6), var(--accent-secondary, #8b5cf6));
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .reset-submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }
        
        .reset-submit-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .reset-submit-btn.loading .btn-text {
            opacity: 0;
        }
        
        .reset-submit-btn.loading .btn-loader {
            opacity: 1;
        }
        
        .btn-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .btn-loader .spinner {
            width: 24px;
            height: 24px;
            animation: rotate 1s linear infinite;
        }
        
        @keyframes rotate {
            100% { transform: rotate(360deg); }
        }
        
        .btn-loader .path {
            stroke: white;
            stroke-linecap: round;
            animation: dash 1.5s ease-in-out infinite;
        }
        
        @keyframes dash {
            0% {
                stroke-dasharray: 1, 150;
                stroke-dashoffset: 0;
            }
            50% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -35;
            }
            100% {
                stroke-dasharray: 90, 150;
                stroke-dashoffset: -124;
            }
        }
        
        .reset-back-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1.5rem;
            color: var(--text-secondary, #6b7280);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }
        
        .reset-back-link:hover {
            color: var(--accent-primary, #3b82f6);
        }
        
        /* Estado de exito */
        .reset-success {
            text-align: center;
            padding: 1rem 0;
        }
        
        .reset-success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
            animation: scaleIn 0.3s ease;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        
        .reset-success-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary, #111827);
            margin-bottom: 0.5rem;
        }
        
        .reset-success-text {
            color: var(--text-secondary, #6b7280);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Estado de error */
        .reset-error-state {
            text-align: center;
            padding: 1rem 0;
        }
        
        .reset-error-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            color: white;
        }
        
        .reset-error-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary, #111827);
            margin-bottom: 0.5rem;
        }
        
        .reset-error-text {
            color: var(--text-secondary, #6b7280);
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        /* Estado de carga inicial */
        .reset-loading {
            text-align: center;
            padding: 2rem 0;
        }
        
        .reset-loading .spinner {
            width: 48px;
            height: 48px;
            animation: rotate 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        .reset-loading .spinner .path {
            stroke: var(--accent-primary, #3b82f6);
        }
        
        .reset-loading-text {
            color: var(--text-secondary, #6b7280);
            font-size: 0.95rem;
        }
        
        /* Modo oscuro */
        [data-theme="dark"] .reset-card {
            background: var(--card-bg, #1f2937);
        }
        
        [data-theme="dark"] .reset-input {
            background: var(--input-bg, #374151);
            border-color: var(--border-color, #4b5563);
            color: var(--text-primary, #f9fafb);
        }
        
        [data-theme="dark"] .password-requirements {
            background: var(--bg-tertiary, #374151);
        }
    </style>
</head>
<body>
    <!-- Elementos decorativos de fondo -->
    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
        <div class="shape shape-4"></div>
    </div>

    <!-- Toggle de tema -->
    <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">
        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <main class="reset-container">
        <div class="reset-card" id="resetCard">
            <!-- Estado de carga inicial -->
            <div class="reset-loading" id="loadingState">
                <svg class="spinner" viewBox="0 0 50 50">
                    <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
                </svg>
                <p class="reset-loading-text">Verificando enlace...</p>
            </div>
        </div>
    </main>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <!-- FIXIFY Core -->
    <script src="../js/core/version.js"></script>
    <script src="../js/core/firebase-config.js"></script>
    <script src="../js/core/firestore.js"></script>
    <script src="../js/core/store.js"></script>
    <script src="../js/core/auth.js"></script>
    
    <script>
        // ========================================
        // RESET PASSWORD HANDLER
        // ========================================
        
        class ResetPasswordHandler {
            constructor() {
                this.oobCode = null;
                this.email = null;
                this.card = document.getElementById('resetCard');
                this.init();
            }
            
            async init() {
                // Inicializar Firebase
                if (!initFirebase()) {
                    this.showError('Error al conectar con el servidor', 'No se pudo inicializar Firebase. Intenta recargar la pagina.');
                    return;
                }
                
                // Inicializar tema
                this.initTheme();
                
                // Verificar si estamos en la pagina intermedia de Firebase y redirigir
                if (this.isFirebaseIntermediatePage()) {
                    this.redirectFromIntermediatePage();
                    return;
                }
                
                // Obtener parametros de la URL - intentar múltiples métodos
                const params = new URLSearchParams(window.location.search);
                let mode = params.get('mode');
                this.oobCode = params.get('oobCode');
                
                console.log('URL completa:', window.location.href);
                console.log('Query params:', window.location.search);
                console.log('Hash:', window.location.hash);
                console.log('Mode inicial:', mode, 'oobCode inicial:', this.oobCode ? 'present' : 'missing');
                
                // Si no hay parametros en la URL, intentar obtenerlos del hash
                if (!mode || !this.oobCode) {
                    const hashParams = this.getHashParams();
                    console.log('Hash params:', hashParams);
                    if (hashParams.mode && hashParams.oobCode) {
                        mode = hashParams.mode;
                        this.oobCode = hashParams.oobCode;
                        // Redirigir a nuestra pagina con los parametros correctos en la query string
                        const newUrl = `${window.location.origin}${window.location.pathname}?mode=${mode}&oobCode=${this.oobCode}`;
                        console.log('Redirigiendo desde hash a:', newUrl);
                        window.location.href = newUrl;
                        return;
                    }
                }
                
                // También intentar obtener del hash completo (Firebase a veces usa #)
                if ((!mode || !this.oobCode) && window.location.hash) {
                    const hash = window.location.hash.substring(1);
                    const hashUrlParams = new URLSearchParams(hash);
                    const hashMode = hashUrlParams.get('mode');
                    const hashOobCode = hashUrlParams.get('oobCode');
                    
                    if (hashMode && hashOobCode) {
                        mode = hashMode;
                        this.oobCode = hashOobCode;
                        console.log('Encontrados en hash URLSearchParams:', mode, this.oobCode);
                        // Redirigir con parámetros en query string
                        const newUrl = `${window.location.origin}${window.location.pathname}?mode=${mode}&oobCode=${this.oobCode}`;
                        window.location.href = newUrl;
                        return;
                    }
                }
                
                console.log('Reset Password - Mode final:', mode, 'Code final:', this.oobCode ? 'present' : 'missing');
                
                // Verificar que sea un reset de password
                if (mode !== 'resetPassword' || !this.oobCode) {
                    console.error('Parámetros faltantes o inválidos. Mode:', mode, 'oobCode:', this.oobCode ? 'present' : 'missing');
                    this.showError('Enlace invalido', 'El enlace que usaste no es valido o ha expirado. Solicita un nuevo enlace de recuperacion.');
                    return;
                }
                
                // Verificar el codigo con Firebase
                await this.verifyCode();
            }
            
            isFirebaseIntermediatePage() {
                // Detectar si estamos en la pagina intermedia de Firebase
                return window.location.hostname.includes('firebaseapp.com') && 
                       window.location.pathname.includes('/__/auth/action');
            }
            
            redirectFromIntermediatePage() {
                console.log('Detectada página intermedia de Firebase');
                console.log('URL completa:', window.location.href);
                
                // Obtener parametros de la URL de Firebase
                const params = new URLSearchParams(window.location.search);
                const mode = params.get('mode');
                const oobCode = params.get('oobCode');
                const continueUrl = params.get('continueUrl');
                
                console.log('Parámetros de Firebase:', { mode, oobCode, continueUrl });
                
                if (mode === 'resetPassword' && oobCode) {
                    // Si hay continueUrl, usarla directamente
                    if (continueUrl) {
                        try {
                            const decodedUrl = decodeURIComponent(continueUrl);
                            console.log('continueUrl decodificado:', decodedUrl);
                            // Agregar los parametros a la URL de destino
                            const url = new URL(decodedUrl);
                            url.searchParams.set('mode', mode);
                            url.searchParams.set('oobCode', oobCode);
                            const finalUrl = url.toString();
                            console.log('Redirigiendo a continueUrl con parámetros:', finalUrl);
                            window.location.href = finalUrl;
                            return;
                        } catch (e) {
                            console.error('Error al procesar continueUrl:', e);
                        }
                    }
                    
                    // Si no hay continueUrl, construir la URL de nuestra pagina
                    // Detectar si estamos en GitHub Pages y usar la ruta correcta
                    let resetPath = '/pages/reset-password.html';
                    
                    // Si el continueUrl original tenía una ruta, intentar extraerla
                    if (continueUrl) {
                        try {
                            const decoded = decodeURIComponent(continueUrl);
                            const url = new URL(decoded);
                            console.log('Extrayendo pathname de continueUrl:', url.pathname);
                            // Si la ruta incluye el nombre del repositorio, mantenerlo
                            if (url.pathname.includes('/FIXIFY/')) {
                                resetPath = '/FIXIFY/pages/reset-password.html';
                            } else if (url.pathname.startsWith('/pages/')) {
                                resetPath = url.pathname;
                            }
                        } catch (e) {
                            console.warn('No se pudo parsear continueUrl:', e);
                        }
                    }
                    
                    const baseUrl = continueUrl ? 
                        (() => {
                            try {
                                return new URL(decodeURIComponent(continueUrl)).origin;
                            } catch {
                                return 'https://adrianfv725.github.io';
                            }
                        })() : 
                        'https://adrianfv725.github.io';
                    
                    const resetUrl = `${baseUrl}${resetPath}?mode=${mode}&oobCode=${oobCode}`;
                    console.log('Redirigiendo a URL construida:', resetUrl);
                    window.location.href = resetUrl;
                } else {
                    console.error('Parámetros inválidos en página intermedia:', { mode, oobCode });
                    this.showError('Enlace invalido', 'El enlace que usaste no es valido o ha expirado.');
                }
            }
            
            getHashParams() {
                const hash = window.location.hash.substring(1);
                const params = {};
                if (hash) {
                    hash.split('&').forEach(param => {
                        const [key, value] = param.split('=');
                        if (key && value) {
                            params[decodeURIComponent(key)] = decodeURIComponent(value);
                        }
                    });
                }
                return params;
            }
            
            initTheme() {
                const savedTheme = localStorage.getItem('fixify-theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                } else if (prefersDark) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    themeToggle.addEventListener('click', () => {
                        const current = document.documentElement.getAttribute('data-theme');
                        const next = current === 'dark' ? 'light' : 'dark';
                        document.documentElement.setAttribute('data-theme', next);
                        localStorage.setItem('fixify-theme', next);
                    });
                }
            }
            
            async verifyCode() {
                try {
                    const auth = getFirebaseAuth();
                    
                    // Verificar el action code
                    const info = await auth.verifyPasswordResetCode(this.oobCode);
                    this.email = info;
                    
                    console.log('Codigo valido para email:', this.email);
                    
                    // Mostrar formulario de nueva contraseña
                    this.showResetForm();
                    
                } catch (error) {
                    console.error('Error al verificar codigo:', error);
                    
                    let title = 'Enlace invalido';
                    let message = 'El enlace que usaste no es valido o ha expirado.';
                    
                    if (error.code === 'auth/expired-action-code') {
                        title = 'Enlace expirado';
                        message = 'Este enlace de recuperacion ha expirado. Los enlaces son validos por 1 hora. Solicita uno nuevo.';
                    } else if (error.code === 'auth/invalid-action-code') {
                        title = 'Enlace ya utilizado';
                        message = 'Este enlace ya fue utilizado o es invalido. Solicita un nuevo enlace de recuperacion.';
                    }
                    
                    this.showError(title, message);
                }
            }
            
            showResetForm() {
                this.card.innerHTML = `
                    <div class="reset-header">
                        <div class="reset-logo">
                            <span class="reset-logo-icon">F</span>
                            <span class="reset-logo-text">FIXIFY</span>
                        </div>
                        
                        <div class="reset-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        
                        <h1 class="reset-title">Nueva Contraseña</h1>
                        <p class="reset-subtitle">Ingresa tu nueva contraseña para <strong>${this.escapeHtml(this.email)}</strong></p>
                    </div>
                    
                    <form class="reset-form" id="resetForm">
                        <div class="reset-form-group">
                            <label for="newPassword">Nueva contraseña</label>
                            <div class="reset-input-wrapper">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                                <input 
                                    type="password" 
                                    id="newPassword" 
                                    class="reset-input"
                                    placeholder="Ingresa tu nueva contraseña"
                                    required
                                    autocomplete="new-password"
                                    minlength="6"
                                >
                                <button type="button" class="password-toggle" id="toggleNewPassword" aria-label="Mostrar contraseña">
                                    <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                        <line x1="1" y1="1" x2="23" y2="23"></line>
                                    </svg>
                                </button>
                            </div>
                            <span class="reset-error" id="newPasswordError"></span>
                            
                            <div class="password-requirements">
                                <strong>La contraseña debe tener:</strong>
                                <ul id="passwordRequirements">
                                    <li id="reqLength">Al menos 6 caracteres</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="reset-form-group">
                            <label for="confirmPassword">Confirmar contraseña</label>
                            <div class="reset-input-wrapper">
                                <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                                <input 
                                    type="password" 
                                    id="confirmPassword" 
                                    class="reset-input"
                                    placeholder="Confirma tu contraseña"
                                    required
                                    autocomplete="new-password"
                                >
                                <button type="button" class="password-toggle" id="toggleConfirmPassword" aria-label="Mostrar contraseña">
                                    <svg class="eye-open" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                    <svg class="eye-closed" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>
                                        <line x1="1" y1="1" x2="23" y2="23"></line>
                                    </svg>
                                </button>
                            </div>
                            <span class="reset-error" id="confirmPasswordError"></span>
                        </div>
                        
                        <button type="submit" class="reset-submit-btn" id="submitBtn">
                            <span class="btn-text">Restablecer Contraseña</span>
                            <span class="btn-loader">
                                <svg class="spinner" viewBox="0 0 50 50">
                                    <circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5"></circle>
                                </svg>
                            </span>
                        </button>
                    </form>
                    
                    <a href="../index.html" class="reset-back-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                        Volver al inicio de sesion
                    </a>
                `;
                
                // Bind events
                this.bindFormEvents();
            }
            
            bindFormEvents() {
                const form = document.getElementById('resetForm');
                const newPasswordInput = document.getElementById('newPassword');
                const confirmPasswordInput = document.getElementById('confirmPassword');
                const toggleNewPassword = document.getElementById('toggleNewPassword');
                const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
                
                // Toggle password visibility
                toggleNewPassword?.addEventListener('click', () => {
                    this.togglePasswordVisibility(newPasswordInput, toggleNewPassword);
                });
                
                toggleConfirmPassword?.addEventListener('click', () => {
                    this.togglePasswordVisibility(confirmPasswordInput, toggleConfirmPassword);
                });
                
                // Validar contraseña en tiempo real
                newPasswordInput?.addEventListener('input', () => {
                    this.validatePasswordRequirements(newPasswordInput.value);
                    this.clearError('newPasswordError');
                });
                
                confirmPasswordInput?.addEventListener('input', () => {
                    this.clearError('confirmPasswordError');
                });
                
                // Submit form
                form?.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleSubmit();
                });
            }
            
            togglePasswordVisibility(input, button) {
                const type = input.getAttribute('type');
                
                if (type === 'password') {
                    input.setAttribute('type', 'text');
                    button.classList.add('active');
                } else {
                    input.setAttribute('type', 'password');
                    button.classList.remove('active');
                }
            }
            
            validatePasswordRequirements(password) {
                const reqLength = document.getElementById('reqLength');
                
                if (password.length >= 6) {
                    reqLength?.classList.add('valid');
                } else {
                    reqLength?.classList.remove('valid');
                }
            }
            
            showFieldError(fieldId, message) {
                const field = document.getElementById(fieldId);
                const input = document.getElementById(fieldId.replace('Error', ''));
                
                if (field) {
                    field.textContent = message;
                }
                if (input) {
                    input.classList.add('error');
                }
            }
            
            clearError(fieldId) {
                const field = document.getElementById(fieldId);
                const input = document.getElementById(fieldId.replace('Error', ''));
                
                if (field) {
                    field.textContent = '';
                }
                if (input) {
                    input.classList.remove('error');
                }
            }
            
            async handleSubmit() {
                const newPassword = document.getElementById('newPassword')?.value;
                const confirmPassword = document.getElementById('confirmPassword')?.value;
                const submitBtn = document.getElementById('submitBtn');
                
                // Validar
                let hasError = false;
                
                if (!newPassword || newPassword.length < 6) {
                    this.showFieldError('newPasswordError', 'La contraseña debe tener al menos 6 caracteres');
                    hasError = true;
                }
                
                if (newPassword !== confirmPassword) {
                    this.showFieldError('confirmPasswordError', 'Las contraseñas no coinciden');
                    hasError = true;
                }
                
                if (hasError) return;
                
                // Mostrar loading
                submitBtn.classList.add('loading');
                submitBtn.disabled = true;
                
                try {
                    const auth = getFirebaseAuth();
                    
                    // Confirmar el reset con Firebase
                    await auth.confirmPasswordReset(this.oobCode, newPassword);
                    
                    console.log('Contraseña restablecida exitosamente para:', this.email);
                    
                    // Limpiar la contraseña legacy en Firestore (si existe)
                    try {
                        await this.clearLegacyPassword(this.email);
                    } catch (e) {
                        console.warn('No se pudo limpiar contraseña legacy:', e);
                    }
                    
                    // Registrar actividad
                    try {
                        await FirestoreService.logActivity('password_reset_completed', { 
                            email: this.email 
                        });
                    } catch (e) {
                        console.warn('No se pudo registrar actividad');
                    }
                    
                    // Mostrar exito
                    this.showSuccess();
                    
                } catch (error) {
                    console.error('Error al restablecer contraseña:', error);
                    
                    submitBtn.classList.remove('loading');
                    submitBtn.disabled = false;
                    
                    let errorMessage = 'Error al restablecer la contraseña';
                    
                    if (error.code === 'auth/expired-action-code') {
                        errorMessage = 'El enlace ha expirado. Solicita uno nuevo.';
                    } else if (error.code === 'auth/invalid-action-code') {
                        errorMessage = 'El enlace ya no es valido. Solicita uno nuevo.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'La contraseña es muy debil. Usa al menos 6 caracteres.';
                    }
                    
                    this.showFieldError('newPasswordError', errorMessage);
                }
            }
            
            async clearLegacyPassword(email) {
                // Buscar el usuario en Firestore y eliminar el campo password
                const userData = await FirestoreService.getUserByEmail(email);
                
                if (userData && userData.password) {
                    // Actualizar el documento removiendo el password y marcando como migrado
                    const db = getFirebaseDb();
                    await db.collection('users').doc(userData.id).update({
                        password: firebase.firestore.FieldValue.delete(),
                        migratedAt: new Date().toISOString(),
                        passwordResetAt: new Date().toISOString()
                    });
                    
                    console.log('Contraseña legacy eliminada de Firestore');
                }
            }
            
            showSuccess() {
                this.card.innerHTML = `
                    <div class="reset-header">
                        <div class="reset-logo">
                            <span class="reset-logo-icon">F</span>
                            <span class="reset-logo-text">FIXIFY</span>
                        </div>
                    </div>
                    
                    <div class="reset-success">
                        <div class="reset-success-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        
                        <h2 class="reset-success-title">Contraseña Restablecida</h2>
                        <p class="reset-success-text">
                            Tu contraseña ha sido actualizada correctamente.<br>
                            Ahora puedes iniciar sesion con tu nueva contraseña.
                        </p>
                    </div>
                    
                    <a href="../index.html" class="reset-submit-btn" style="display: block; text-align: center; text-decoration: none; margin-top: 1.5rem;">
                        Ir a Iniciar Sesion
                    </a>
                `;
                
                // Redirigir automaticamente despues de 5 segundos
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 5000);
            }
            
            showError(title, message) {
                this.card.innerHTML = `
                    <div class="reset-header">
                        <div class="reset-logo">
                            <span class="reset-logo-icon">F</span>
                            <span class="reset-logo-text">FIXIFY</span>
                        </div>
                    </div>
                    
                    <div class="reset-error-state">
                        <div class="reset-error-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        
                        <h2 class="reset-error-title">${this.escapeHtml(title)}</h2>
                        <p class="reset-error-text">${this.escapeHtml(message)}</p>
                    </div>
                    
                    <a href="../index.html" class="reset-submit-btn" style="display: block; text-align: center; text-decoration: none; margin-top: 1.5rem;">
                        Volver al Inicio
                    </a>
                    
                    <p style="text-align: center; margin-top: 1rem; color: var(--text-secondary, #6b7280); font-size: 0.85rem;">
                        Puedes solicitar un nuevo enlace desde la pagina de inicio de sesion.
                    </p>
                `;
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // Inicializar cuando el DOM este listo
        document.addEventListener('DOMContentLoaded', () => {
            new ResetPasswordHandler();
        });
        
        // Prevenir flash de tema incorrecto
        (function() {
            const savedTheme = localStorage.getItem('fixify-theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else if (prefersDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</body>
</html>

